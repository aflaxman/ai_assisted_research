<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Research News Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        h1 small {
            font-weight: 400;
            opacity: 0.8;
            font-size: 0.9rem;
            display: block;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #48bb78;
            border-color: #48bb78;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #e53e3e;
            border-color: #e53e3e;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c5282;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        .important-section {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .important-section h2 {
            color: #92400e;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .important-section .article-mini {
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .important-section .article-mini:last-child {
            margin-bottom: 0;
        }

        .important-section .article-title {
            flex: 1;
            font-size: 0.9rem;
        }

        .important-section .article-title a {
            color: #1a365d;
            text-decoration: none;
        }

        .important-section .article-title a:hover {
            text-decoration: underline;
        }

        .important-section .relevance-badge {
            background: #dc2626;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 5px;
        }

        .filter-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #2c5282;
        }

        .filter-btn.active {
            background: #2c5282;
            color: white;
            border-color: #2c5282;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #2c5282;
        }

        .articles-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .article {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .article:last-child {
            border-bottom: none;
        }

        .article:hover {
            background: #f9fafb;
        }

        .article.read {
            opacity: 0.6;
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 8px;
        }

        .article-title-main {
            flex: 1;
        }

        .article-title-main a {
            color: #1a365d;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
        }

        .article-title-main a:hover {
            text-decoration: underline;
        }

        .article-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .article-source {
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 3px;
        }

        .article-category {
            text-transform: capitalize;
        }

        .article-category.research {
            color: #2563eb;
        }

        .article-category.policy {
            color: #7c3aed;
        }

        .article-category.news {
            color: #059669;
        }

        .article-category.social {
            color: #0085ff;
        }

        .article-summary {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .article-actions {
            display: flex;
            gap: 10px;
        }

        .article-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #888;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .article-actions button:hover {
            color: #2c5282;
        }

        .article-actions button.starred {
            color: #f59e0b;
        }

        .relevance-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .relevance-high {
            background: #dc2626;
        }

        .relevance-medium {
            background: #f59e0b;
        }

        .relevance-low {
            background: #10b981;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .loading-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #2c5282;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            color: #666;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 8px;
            height: 12px;
            margin: 15px auto;
            max-width: 400px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.3s ease-out;
            border-radius: 8px;
        }

        .feed-status {
            font-size: 0.9rem;
            color: #2c5282;
            font-weight: 500;
            margin-top: 10px;
        }

        .feed-list {
            margin-top: 15px;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .feed-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.85rem;
            color: #555;
        }

        .feed-item-icon {
            width: 20px;
            text-align: center;
        }

        .feed-item.pending .feed-item-icon::before { content: "‚óã"; color: #aaa; }
        .feed-item.loading .feed-item-icon::before { content: "‚óê"; color: #2c5282; animation: pulse 0.5s infinite; }
        .feed-item.success .feed-item-icon::before { content: "‚úì"; color: #48bb78; }
        .feed-item.error .feed-item-icon::before { content: "‚úó"; color: #e53e3e; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .feed-item-count {
            margin-left: auto;
            color: #48bb78;
            font-weight: 500;
        }

        .pubmed-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #1a365d;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.2s;
        }

        .pubmed-link:hover {
            background: #2c5282;
            color: white;
        }

        .bluesky-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #0085ff;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.2s;
        }

        .bluesky-link:hover {
            background: #0066cc;
            color: white;
        }

        .engagement-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }

        .engagement-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .engagement-stat.likes { color: #e53e3e; }
        .engagement-stat.reposts { color: #38a169; }
        .engagement-stat.replies { color: #3182ce; }

        .social-badge {
            background: #0085ff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .article-links {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .info-box {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #2c5282;
        }

        .info-box a {
            color: #2b6cb0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header .container {
                flex-direction: column;
                text-align: center;
            }

            .stats-bar {
                justify-content: center;
            }

            .filters {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>
                Drug Research News Tracker
                <small>Opioid Simulation & Policy Updates</small>
            </h1>
            <div class="header-actions">
                <button class="btn" onclick="markAllRead()">Mark All Read</button>
                <button class="btn btn-danger" onclick="clearData()">Clear Data</button>
                <button class="btn btn-primary" id="refresh-btn" onclick="refreshFeeds()">
                    <span id="refresh-text">Refresh Feeds</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="info-box" id="info-box">
            <strong>Powered by PubMed + Bluesky:</strong> Searches PubMed for research articles and Bluesky for social discussions.
            Filter by "Social" to see posts with the most engagement (buzz). Data stored in your browser.
        </div>

        <div class="stats-bar" id="stats-bar">
            <div class="stat">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-unread">0</div>
                <div class="stat-label">Unread</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-starred">0</div>
                <div class="stat-label">Saved</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-important">0</div>
                <div class="stat-label">High Relevance</div>
            </div>
        </div>

        <div id="loading-container" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-title">Searching PubMed</div>
            <div class="loading-subtitle">Finding recent research on opioid simulation and drug policy...</div>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="feed-status" id="feed-status">Starting...</div>
            <div class="feed-list" id="feed-list"></div>
        </div>

        <div class="important-section" id="important-section" style="display: none;">
            <h2>
                <span>&#9888;</span> Don't Miss - High Relevance Articles
            </h2>
            <div id="important-articles"></div>
        </div>

        <div class="filters">
            <div class="filter-group" id="category-filters">
                <button class="filter-btn active" data-category="all">All</button>
                <button class="filter-btn" data-category="research">Research</button>
                <button class="filter-btn" data-category="policy">Policy</button>
                <button class="filter-btn" data-category="social">Social</button>
            </div>
            <div class="filter-group" id="status-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="unread">Unread</button>
                <button class="filter-btn" data-filter="starred">Saved</button>
            </div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search articles...">
            </div>
        </div>

        <div class="articles-list" id="articles-list">
            <div class="empty-state">Loading will begin automatically...</div>
        </div>
    </div>

    <script>
        // Configuration
        const KEYWORDS = {
            high: [
                "simulation", "computational model", "agent-based model", "microsimulation",
                "system dynamics", "mathematical model", "predictive model", "markov model",
                "monte carlo", "discrete event simulation"
            ],
            medium: [
                "opioid", "opioids", "fentanyl", "heroin", "methadone", "buprenorphine",
                "naloxone", "narcan", "overdose", "substance use disorder", "opioid use disorder",
                "OUD", "medication-assisted treatment", "MAT", "harm reduction", "drug policy"
            ],
            low: [
                "addiction", "substance abuse", "drug use", "public health", "epidemiology",
                "health policy", "treatment", "prevention", "intervention"
            ]
        };

        // PubMed eutils API (CORS enabled, reliable)
        const PUBMED_BASE = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils';

        // PubMed search queries for different topics
        const PUBMED_SEARCHES = [
            {
                name: "Opioid Simulation Models",
                query: "(opioid OR fentanyl) AND (simulation OR mathematical model OR computational model)",
                category: "research"
            },
            {
                name: "Drug Policy Modeling",
                query: "(drug policy OR opioid policy) AND (model OR simulation OR cost-effectiveness)",
                category: "research"
            },
            {
                name: "Overdose Prevention",
                query: "(overdose OR naloxone) AND (prediction OR model OR intervention)",
                category: "research"
            },
            {
                name: "Substance Use Treatment",
                query: "(substance use disorder OR opioid use disorder) AND (treatment OR buprenorphine OR methadone)",
                category: "research"
            },
            {
                name: "Harm Reduction Research",
                query: "(harm reduction) AND (opioid OR drug use OR injection)",
                category: "policy"
            }
        ];

        // Bluesky search queries for social discussions
        const BLUESKY_SEARCHES = [
            {
                name: "Opioid Research Discussion",
                query: "opioid research"
            },
            {
                name: "Drug Policy Discussion",
                query: "drug policy fentanyl"
            },
            {
                name: "Overdose Prevention",
                query: "overdose naloxone"
            }
        ];

        const BLUESKY_API = 'https://public.api.bsky.app/xrpc';

        // State
        let articles = [];
        let currentCategory = 'all';
        let currentFilter = 'all';
        let currentSearch = '';

        // LocalStorage keys
        const STORAGE_KEY = 'drug_research_tracker_articles';
        const READ_KEY = 'drug_research_tracker_read';
        const STARRED_KEY = 'drug_research_tracker_starred';
        const HIDDEN_KEY = 'drug_research_tracker_hidden';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderArticles();
            updateStats();
            setupEventListeners();

            // Auto-refresh if no articles or data is old
            const lastFetch = localStorage.getItem('drug_research_tracker_last_fetch');
            const hourAgo = Date.now() - (60 * 60 * 1000);
            if (articles.length === 0 || !lastFetch || parseInt(lastFetch) < hourAgo) {
                setTimeout(() => refreshFeeds(), 1000);
            }
        });

        function setupEventListeners() {
            document.querySelectorAll('#category-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#category-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderArticles();
                });
            });

            document.querySelectorAll('#status-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#status-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderArticles();
                });
            });

            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearch = e.target.value.toLowerCase();
                    renderArticles();
                }, 300);
            });
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    articles = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading from storage:', e);
                articles = [];
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(articles));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        function getReadSet() {
            try {
                return new Set(JSON.parse(localStorage.getItem(READ_KEY) || '[]'));
            } catch { return new Set(); }
        }

        function getStarredSet() {
            try {
                return new Set(JSON.parse(localStorage.getItem(STARRED_KEY) || '[]'));
            } catch { return new Set(); }
        }

        function getHiddenSet() {
            try {
                return new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY) || '[]'));
            } catch { return new Set(); }
        }

        function saveReadSet(set) {
            localStorage.setItem(READ_KEY, JSON.stringify([...set]));
        }

        function saveStarredSet(set) {
            localStorage.setItem(STARRED_KEY, JSON.stringify([...set]));
        }

        function saveHiddenSet(set) {
            localStorage.setItem(HIDDEN_KEY, JSON.stringify([...set]));
        }

        function calculateRelevance(title, summary) {
            const text = `${title} ${summary}`.toLowerCase();
            let score = 0;

            const highMatches = KEYWORDS.high.filter(kw => text.includes(kw.toLowerCase())).length;
            const mediumMatches = KEYWORDS.medium.filter(kw => text.includes(kw.toLowerCase())).length;
            const lowMatches = KEYWORDS.low.filter(kw => text.includes(kw.toLowerCase())).length;

            if (highMatches > 0 && mediumMatches > 0) {
                score = 100 + (highMatches * 10) + (mediumMatches * 5);
            } else if (highMatches > 0) {
                score = 50 + (highMatches * 5) + (lowMatches * 2);
            } else if (mediumMatches > 0) {
                score = 30 + (mediumMatches * 3) + (lowMatches * 2);
            } else {
                score = lowMatches * 2;
            }

            return Math.min(score, 200);
        }

        function generateId(link, title) {
            // Simple hash function
            const str = link + title;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        async function searchPubMed(query) {
            // Search for article IDs
            const searchUrl = `${PUBMED_BASE}/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmax=20&retmode=json&sort=date`;
            const searchResponse = await fetch(searchUrl);

            if (!searchResponse.ok) {
                throw new Error(`Search failed: ${searchResponse.status}`);
            }

            const searchData = await searchResponse.json();
            const ids = searchData.esearchresult?.idlist || [];

            if (ids.length === 0) {
                return [];
            }

            // Get article summaries
            const summaryUrl = `${PUBMED_BASE}/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`;
            const summaryResponse = await fetch(summaryUrl);

            if (!summaryResponse.ok) {
                throw new Error(`Summary failed: ${summaryResponse.status}`);
            }

            const summaryData = await summaryResponse.json();
            return { ids, summaries: summaryData.result };
        }

        function parsePubMedResults(data, searchConfig) {
            const newArticles = [];

            if (!data.ids || !data.summaries) {
                return newArticles;
            }

            data.ids.forEach(id => {
                const article = data.summaries[id];
                if (!article || article.error) return;

                const title = article.title || 'No title';
                const link = `https://pubmed.ncbi.nlm.nih.gov/${id}/`;
                const authors = (article.authors || []).slice(0, 3).map(a => a.name).join(', ');
                const source = article.source || '';
                const pubDate = article.pubdate || '';
                const summary = authors ? `${authors}. ${source}. ${pubDate}` : `${source}. ${pubDate}`;

                const relevance = calculateRelevance(title, summary);

                newArticles.push({
                    id: `pubmed_${id}`,
                    title,
                    link,
                    summary,
                    source: searchConfig.name,
                    category: searchConfig.category,
                    published: parsePubMedDate(pubDate),
                    relevance
                });
            });

            return newArticles;
        }

        function parsePubMedDate(dateStr) {
            if (!dateStr) return new Date().toISOString();
            try {
                // PubMed dates like "2025 Dec 24" or "2025 Dec"
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toISOString();
                }
            } catch (e) {}
            return new Date().toISOString();
        }

        async function searchBluesky(query) {
            const url = `${BLUESKY_API}/app.bsky.feed.searchPosts?q=${encodeURIComponent(query)}&limit=25&sort=top`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`Bluesky search failed: ${response.status}`);
            }

            return await response.json();
        }

        function parseBlueskyResults(data, searchName) {
            const newArticles = [];

            if (!data.posts || !Array.isArray(data.posts)) {
                return newArticles;
            }

            data.posts.forEach(post => {
                const record = post.record || {};
                const author = post.author || {};
                const text = record.text || '';
                const createdAt = record.createdAt || '';

                // Build Bluesky post URL
                const postUri = post.uri || '';
                const uriParts = postUri.split('/');
                const postId = uriParts[uriParts.length - 1];
                const handle = author.handle || '';
                const link = handle && postId
                    ? `https://bsky.app/profile/${handle}/post/${postId}`
                    : '';

                // Get engagement metrics
                const likes = post.likeCount || 0;
                const reposts = post.repostCount || 0;
                const replies = post.replyCount || 0;

                // Calculate buzz score (engagement-weighted)
                const buzzScore = (likes * 2) + (reposts * 3) + replies;

                // Skip low-engagement posts
                if (buzzScore < 1) return;

                const displayName = author.displayName || handle;
                const summary = `@${handle} ‚Ä¢ ${likes} likes ‚Ä¢ ${reposts} reposts`;

                newArticles.push({
                    id: `bsky_${postId}_${handle}`,
                    title: text.substring(0, 200) + (text.length > 200 ? '...' : ''),
                    link,
                    summary,
                    source: `Bluesky: ${searchName}`,
                    category: 'social',
                    published: createdAt ? new Date(createdAt).toISOString() : new Date().toISOString(),
                    relevance: Math.min(buzzScore, 200),
                    // Extra fields for social posts
                    isBluesky: true,
                    authorHandle: handle,
                    authorName: displayName,
                    likes,
                    reposts,
                    replies,
                    fullText: text
                });
            });

            // Sort by buzz/engagement
            newArticles.sort((a, b) => b.relevance - a.relevance);

            return newArticles;
        }

        async function refreshFeeds() {
            const btn = document.getElementById('refresh-btn');
            const text = document.getElementById('refresh-text');
            const loadingContainer = document.getElementById('loading-container');
            const progressFill = document.getElementById('progress-fill');
            const feedStatus = document.getElementById('feed-status');
            const feedList = document.getElementById('feed-list');
            const articlesList = document.getElementById('articles-list');

            btn.disabled = true;
            text.textContent = 'Fetching...';
            loadingContainer.style.display = 'block';
            articlesList.style.display = 'none';
            progressFill.style.width = '0%';

            // Build search status list (PubMed + Bluesky)
            const allSearches = [
                ...PUBMED_SEARCHES.map(s => ({ ...s, type: 'pubmed' })),
                ...BLUESKY_SEARCHES.map(s => ({ ...s, type: 'bluesky', category: 'social' }))
            ];

            feedList.innerHTML = allSearches.map((search, i) => `
                <div class="feed-item pending" id="feed-item-${i}">
                    <span class="feed-item-icon"></span>
                    <span class="feed-item-name">${search.type === 'bluesky' ? 'ü¶ã ' : 'üìö '}${search.name}</span>
                    <span class="feed-item-count" id="feed-count-${i}"></span>
                </div>
            `).join('');

            const existingIds = new Set(articles.map(a => a.id));
            let totalNewCount = 0;
            let completed = 0;

            for (let i = 0; i < allSearches.length; i++) {
                const search = allSearches[i];
                const feedItem = document.getElementById(`feed-item-${i}`);
                const feedCount = document.getElementById(`feed-count-${i}`);

                feedItem.className = 'feed-item loading';
                const sourceLabel = search.type === 'bluesky' ? 'Bluesky' : 'PubMed';
                feedStatus.textContent = `Searching ${sourceLabel}: ${search.name}...`;

                let feedNewCount = 0;
                try {
                    let newArticles = [];

                    if (search.type === 'pubmed') {
                        const data = await searchPubMed(search.query);
                        newArticles = parsePubMedResults(data, search);
                    } else if (search.type === 'bluesky') {
                        const data = await searchBluesky(search.query);
                        newArticles = parseBlueskyResults(data, search.name);
                    }

                    newArticles.forEach(article => {
                        if (!existingIds.has(article.id)) {
                            articles.push(article);
                            existingIds.add(article.id);
                            feedNewCount++;
                            totalNewCount++;
                        }
                    });

                    feedItem.className = 'feed-item success';
                    feedCount.textContent = feedNewCount > 0 ? `+${feedNewCount}` : `${newArticles.length} found`;
                } catch (e) {
                    console.error(`Failed to search ${search.name}:`, e);
                    feedItem.className = 'feed-item error';
                    feedCount.textContent = 'failed';
                }

                completed++;
                progressFill.style.width = `${(completed / allSearches.length) * 100}%`;

                // Small delay between API calls
                if (i < allSearches.length - 1) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            // Sort by date (newest first), then by relevance
            articles.sort((a, b) => {
                const dateA = new Date(a.published);
                const dateB = new Date(b.published);
                if (dateB - dateA !== 0) return dateB - dateA;
                return b.relevance - a.relevance;
            });

            // Keep only last 500 articles
            if (articles.length > 500) {
                articles = articles.slice(0, 500);
            }

            saveToStorage();
            localStorage.setItem('drug_research_tracker_last_fetch', Date.now().toString());

            feedStatus.textContent = totalNewCount > 0
                ? `Done! Found ${totalNewCount} new articles.`
                : `Done! ${articles.length} articles loaded.`;

            setTimeout(() => {
                loadingContainer.style.display = 'none';
                articlesList.style.display = 'block';
                btn.disabled = false;
                text.textContent = 'Refresh Feeds';
                renderArticles();
                updateStats();
            }, 1500);
        }

        function updateStats() {
            const readSet = getReadSet();
            const starredSet = getStarredSet();
            const hiddenSet = getHiddenSet();

            const visible = articles.filter(a => !hiddenSet.has(a.id));
            const unread = visible.filter(a => !readSet.has(a.id));
            const starred = visible.filter(a => starredSet.has(a.id));
            const important = visible.filter(a => a.relevance >= 100 && !readSet.has(a.id));

            document.getElementById('stat-total').textContent = visible.length;
            document.getElementById('stat-unread').textContent = unread.length;
            document.getElementById('stat-starred').textContent = starred.length;
            document.getElementById('stat-important').textContent = important.length;

            // Update important section
            const importantSection = document.getElementById('important-section');
            const importantArticles = document.getElementById('important-articles');

            if (important.length > 0) {
                importantSection.style.display = 'block';
                importantArticles.innerHTML = important.slice(0, 5).map(article => `
                    <div class="article-mini">
                        <div class="article-title">
                            <a href="${article.link}" target="_blank" onclick="markAsRead('${article.id}')">${article.title}</a>
                        </div>
                        <span class="relevance-badge">${article.relevance}</span>
                    </div>
                `).join('');
            } else {
                importantSection.style.display = 'none';
            }
        }

        function renderArticles() {
            const list = document.getElementById('articles-list');
            const readSet = getReadSet();
            const starredSet = getStarredSet();
            const hiddenSet = getHiddenSet();

            let filtered = articles.filter(a => !hiddenSet.has(a.id));

            if (currentCategory !== 'all') {
                filtered = filtered.filter(a => a.category === currentCategory);
            }

            if (currentFilter === 'unread') {
                filtered = filtered.filter(a => !readSet.has(a.id));
            } else if (currentFilter === 'starred') {
                filtered = filtered.filter(a => starredSet.has(a.id));
            }

            if (currentSearch) {
                filtered = filtered.filter(a =>
                    a.title.toLowerCase().includes(currentSearch) ||
                    a.summary.toLowerCase().includes(currentSearch)
                );
            }

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state">No articles found. Try refreshing feeds or adjusting filters.</div>';
                return;
            }

            list.innerHTML = filtered.slice(0, 100).map(article => {
                const isRead = readSet.has(article.id);
                const isStarred = starredSet.has(article.id);
                const relevanceClass = article.relevance >= 100 ? 'high' :
                                      article.relevance >= 50 ? 'medium' : 'low';
                const date = new Date(article.published).toLocaleDateString();

                // Build links section
                let linksHtml = '<div class="article-links">';
                if (article.isBluesky) {
                    linksHtml += `<a href="${article.link}" target="_blank" class="bluesky-link" onclick="markAsRead('${article.id}')">ü¶ã View on Bluesky</a>`;
                } else if (article.link.includes('pubmed.ncbi.nlm.nih.gov')) {
                    linksHtml += `<a href="${article.link}" target="_blank" class="pubmed-link" onclick="markAsRead('${article.id}')">üìö View on PubMed</a>`;
                }
                linksHtml += '</div>';

                // Build engagement stats for Bluesky posts
                let engagementHtml = '';
                if (article.isBluesky) {
                    engagementHtml = `
                        <div class="engagement-stats">
                            <span class="engagement-stat likes">‚ô• ${article.likes} likes</span>
                            <span class="engagement-stat reposts">üîÅ ${article.reposts} reposts</span>
                            <span class="engagement-stat replies">üí¨ ${article.replies} replies</span>
                        </div>
                    `;
                }

                // Category badge
                const categoryBadge = article.isBluesky
                    ? '<span class="social-badge">Social</span>'
                    : '';

                return `
                    <div class="article ${isRead ? 'read' : ''}" data-id="${article.id}">
                        <div class="article-header">
                            <div class="article-title-main">
                                <span class="relevance-indicator relevance-${relevanceClass}"></span>
                                <a href="${article.link}" target="_blank" onclick="markAsRead('${article.id}')">${article.title}</a>
                            </div>
                        </div>
                        <div class="article-meta">
                            ${categoryBadge}
                            <span class="article-source">${article.source}</span>
                            <span class="article-category ${article.category}">${article.category}</span>
                            <span class="article-date">${date}</span>
                            ${!article.isBluesky ? `<span class="article-relevance">Relevance: ${article.relevance}</span>` : ''}
                        </div>
                        <div class="article-summary">${article.summary || 'No summary available'}</div>
                        ${engagementHtml}
                        ${linksHtml}
                        <div class="article-actions">
                            <button onclick="toggleStar('${article.id}')" class="${isStarred ? 'starred' : ''}">
                                ${isStarred ? '‚òÖ Saved' : '‚òÜ Save'}
                            </button>
                            <button onclick="toggleRead('${article.id}')">
                                ${isRead ? '‚óã Mark Unread' : '‚óè Mark Read'}
                            </button>
                            <button onclick="hideArticle('${article.id}')">‚úï Hide</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAsRead(id) {
            const readSet = getReadSet();
            readSet.add(id);
            saveReadSet(readSet);
            updateStats();
            // Don't re-render to avoid scroll jump when clicking link
        }

        function toggleRead(id) {
            const readSet = getReadSet();
            if (readSet.has(id)) {
                readSet.delete(id);
            } else {
                readSet.add(id);
            }
            saveReadSet(readSet);
            renderArticles();
            updateStats();
        }

        function toggleStar(id) {
            const starredSet = getStarredSet();
            if (starredSet.has(id)) {
                starredSet.delete(id);
            } else {
                starredSet.add(id);
            }
            saveStarredSet(starredSet);
            renderArticles();
            updateStats();
        }

        function hideArticle(id) {
            const hiddenSet = getHiddenSet();
            hiddenSet.add(id);
            saveHiddenSet(hiddenSet);
            renderArticles();
            updateStats();
        }

        function markAllRead() {
            if (!confirm('Mark all visible articles as read?')) return;

            const readSet = getReadSet();
            const hiddenSet = getHiddenSet();

            articles.forEach(a => {
                if (!hiddenSet.has(a.id)) {
                    if (currentCategory === 'all' || a.category === currentCategory) {
                        readSet.add(a.id);
                    }
                }
            });

            saveReadSet(readSet);
            renderArticles();
            updateStats();
        }

        function clearData() {
            if (!confirm('Clear all articles and reading history? This cannot be undone.')) return;

            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(READ_KEY);
            localStorage.removeItem(STARRED_KEY);
            localStorage.removeItem(HIDDEN_KEY);
            localStorage.removeItem('drug_research_tracker_last_fetch');

            articles = [];
            renderArticles();
            updateStats();
        }
    </script>
</body>
</html>
