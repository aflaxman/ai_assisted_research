<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PPV Calculator</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      color: #1a1a1a;
      line-height: 1.5;
    }

    .container { max-width: 900px; margin: 0 auto; }

    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #2c3e50;
    }

    .subtitle {
      color: #5a6c7d;
      margin: 0 0 24px 0;
      font-size: 0.95rem;
    }

    .card {
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .card-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #5a6c7d;
      margin: 0 0 16px 0;
    }

    /* PPV Result */
    .result-section {
      text-align: center;
      padding: 24px;
    }

    .ppv-label {
      font-size: 0.9rem;
      color: #5a6c7d;
      margin-bottom: 8px;
    }

    .ppv-value {
      font-size: 3.5rem;
      font-weight: 700;
      color: #2980b9;
      line-height: 1;
    }

    .ppv-warning {
      color: #c0392b;
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 1.3em;
    }

    /* Parameters layout: sliders left, inputs right */
    .params-layout {
      display: flex;
      gap: 32px;
      align-items: flex-start;
    }

    /* Vertical sliders container */
    .sliders-group {
      display: flex;
      gap: 24px;
      padding: 16px 8px;
    }

    .slider-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .slider-col label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #5a6c7d;
      text-align: center;
      writing-mode: horizontal-tb;
    }

    /* Vertical range slider */
    input[type="range"].vertical {
      -webkit-appearance: slider-vertical;
      appearance: slider-vertical;
      writing-mode: vertical-lr;
      direction: rtl;
      width: 24px;
      height: 120px;
      background: transparent;
    }

    input[type="range"].vertical::-webkit-slider-runnable-track {
      width: 6px;
      background: #e1e5e9;
      border-radius: 3px;
    }

    input[type="range"].vertical::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #2980b9;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      margin-left: -6px;
    }

    input[type="range"].vertical::-moz-range-track {
      width: 6px;
      background: #e1e5e9;
      border-radius: 3px;
    }

    input[type="range"].vertical::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #2980b9;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .slider-value {
      font-size: 0.8rem;
      color: #34495e;
      font-weight: 500;
    }

    /* Text inputs group */
    .inputs-group {
      flex: 1;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .input-row:last-child { margin-bottom: 0; }

    .input-label {
      width: 90px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #34495e;
    }

    input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      font-size: 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      text-align: right;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #2980b9;
      box-shadow: 0 0 0 2px rgba(41,128,185,0.15);
    }

    .unit {
      font-size: 0.85rem;
      color: #5a6c7d;
    }

    /* Prevalence lookup section */
    .lookup-section {
      margin-top: 24px;
    }

    .lookup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .lookup-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #5a6c7d;
    }

    .sex-toggle {
      display: flex;
      gap: 4px;
    }

    .sex-toggle button {
      padding: 4px 12px;
      font-size: 0.75rem;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #5a6c7d;
      cursor: pointer;
      transition: all 0.15s;
    }

    .sex-toggle button:first-child { border-radius: 4px 0 0 4px; }
    .sex-toggle button:last-child { border-radius: 0 4px 4px 0; }

    .sex-toggle button.active {
      background: #2980b9;
      border-color: #2980b9;
      color: #fff;
    }

    .lookup-content {
      display: flex;
      gap: 16px;
    }

    /* Prevalence table */
    .prevalence-table-wrap {
      flex: 1;
      overflow-x: auto;
    }

    .prevalence-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .prevalence-table th {
      text-align: left;
      padding: 8px 12px;
      background: #f8f9fa;
      border-bottom: 2px solid #e1e5e9;
      font-weight: 600;
      color: #5a6c7d;
    }

    .prevalence-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #e9ecef;
    }

    .prevalence-table tr {
      cursor: pointer;
      transition: background 0.1s;
    }

    .prevalence-table tbody tr:hover {
      background: #f0f7fc;
    }

    .prevalence-table tr.selected {
      background: #e8f4fc;
    }

    .prevalence-table tr.selected td {
      color: #2980b9;
      font-weight: 500;
    }

    .prev-value {
      font-weight: 600;
      color: #2980b9;
    }

    /* Simple world map */
    .map-container {
      width: 180px;
      flex-shrink: 0;
    }

    .map-svg {
      width: 100%;
      height: auto;
    }

    .map-svg .land {
      fill: #e1e5e9;
      stroke: #fff;
      stroke-width: 0.5;
    }

    .map-svg .country {
      fill: #cfd8dc;
      stroke: #fff;
      stroke-width: 0.5;
      transition: fill 0.2s;
    }

    .map-svg .country.active {
      fill: #2980b9;
    }

    .map-svg .country:hover {
      fill: #5dade2;
      cursor: pointer;
    }

    .map-label {
      font-size: 0.7rem;
      color: #7f8c8d;
      text-align: center;
      margin-top: 4px;
    }

    /* Details section */
    .details-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e1e5e9;
    }

    .details-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    .formula {
      font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
      font-size: 0.8rem;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      color: #34495e;
      overflow-x: auto;
    }

    .formula-line { margin-bottom: 4px; }
    .formula-line:last-child { margin-bottom: 0; }
    .intermediate { color: #7f8c8d; }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: #7f8c8d;
      padding: 16px 0;
    }

    /* Responsive */
    @media (max-width: 700px) {
      .params-layout {
        flex-direction: column;
        gap: 20px;
      }

      .sliders-group {
        justify-content: center;
        width: 100%;
      }

      .lookup-content {
        flex-direction: column;
      }

      .map-container {
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Positive Predictive Value Calculator</h1>
    <p class="subtitle">Calculate PPV from sensitivity, specificity, and prevalence</p>

    <!-- Result Card -->
    <div class="card result-section">
      <div class="ppv-label">Positive Predictive Value</div>
      <div class="ppv-value" id="ppvValue">35.7%</div>
      <div class="ppv-warning" id="ppvWarning"></div>
    </div>

    <!-- Inputs Card -->
    <div class="card">
      <h2 class="card-title">Parameters</h2>

      <div class="params-layout">
        <!-- Vertical sliders (not tabbable) -->
        <div class="sliders-group">
          <div class="slider-col">
            <label>Se</label>
            <input type="range" class="vertical" id="sensitivitySlider"
                   min="0" max="100" step="1" value="50" tabindex="-1">
            <span class="slider-value" id="seSliderVal">50</span>
          </div>
          <div class="slider-col">
            <label>Sp</label>
            <input type="range" class="vertical" id="specificitySlider"
                   min="0" max="100" step="1" value="90" tabindex="-1">
            <span class="slider-value" id="spSliderVal">90</span>
          </div>
          <div class="slider-col">
            <label>Prev</label>
            <input type="range" class="vertical" id="prevalenceSlider"
                   min="0" max="100" step="1" value="10" tabindex="-1">
            <span class="slider-value" id="prevSliderVal">10</span>
          </div>
        </div>

        <!-- Text inputs (tabbable) -->
        <div class="inputs-group">
          <div class="input-row">
            <label class="input-label" for="sensitivityNum">Sensitivity</label>
            <input type="number" id="sensitivityNum" min="0" max="100" step="1" value="50">
            <span class="unit">%</span>
          </div>
          <div class="input-row">
            <label class="input-label" for="specificityNum">Specificity</label>
            <input type="number" id="specificityNum" min="0" max="100" step="1" value="90">
            <span class="unit">%</span>
          </div>
          <div class="input-row">
            <label class="input-label" for="prevalenceNum">Prevalence</label>
            <input type="number" id="prevalenceNum" min="0" max="100" step="1" value="10">
            <span class="unit">%</span>
          </div>
        </div>
      </div>

      <!-- Prevalence Lookup Table -->
      <div class="lookup-section">
        <div class="lookup-header">
          <span class="lookup-title">Prevalence Lookup (Stand-in Data)</span>
          <div class="sex-toggle">
            <button type="button" id="btnFemale" class="active">Female</button>
            <button type="button" id="btnMale">Male</button>
          </div>
        </div>

        <div class="lookup-content">
          <div class="prevalence-table-wrap">
            <table class="prevalence-table">
              <thead>
                <tr>
                  <th>Age</th>
                  <th>United States</th>
                  <th>Brazil</th>
                  <th>China</th>
                </tr>
              </thead>
              <tbody id="prevalenceTableBody">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>

          <!-- Simple world map -->
          <div class="map-container">
            <svg class="map-svg" viewBox="0 0 200 100" preserveAspectRatio="xMidYMid meet">
              <!-- Simplified continent outlines -->
              <g class="land">
                <!-- North America -->
                <path d="M10,15 L50,10 L55,35 L40,50 L20,45 L10,30 Z"/>
                <!-- South America -->
                <path d="M35,52 L55,48 L60,70 L50,90 L35,85 L30,65 Z"/>
                <!-- Europe/Africa -->
                <path d="M85,15 L110,12 L115,35 L105,50 L90,55 L80,40 Z"/>
                <path d="M85,58 L105,55 L110,80 L95,90 L80,85 L78,70 Z"/>
                <!-- Asia -->
                <path d="M115,10 L180,8 L190,35 L175,55 L140,50 L115,35 Z"/>
                <!-- Australia -->
                <path d="M160,65 L185,60 L190,80 L175,88 L158,82 Z"/>
              </g>
              <!-- Clickable country markers -->
              <circle class="country" id="mapUS" cx="35" cy="30" r="8" data-location="United States"/>
              <circle class="country" id="mapBrazil" cx="50" cy="70" r="8" data-location="Brazil"/>
              <circle class="country" id="mapChina" cx="155" cy="32" r="8" data-location="China"/>
            </svg>
            <div class="map-label" id="mapLabel">Click to select</div>
          </div>
        </div>
      </div>

      <!-- Details -->
      <div class="details-section">
        <div class="details-title">Calculation Details</div>
        <div class="formula" id="formulaDetails"></div>
      </div>
    </div>

    <footer>PPV calculator • Sensitivity/Specificity/Prevalence</footer>
  </div>

  <script>
    // =========================================================================
    // EXTENDABLE DATA
    // =========================================================================

    const LOCATIONS = ["United States", "Brazil", "China"];
    const AGE_GROUPS = ["60-64", "65-69", "70-74", "75-79", "80-84"];

    // Structure: { location: { sex: { ageGroup: prevalencePercent } } }
    const PREVALENCE_DATA = {
      "United States": {
        "Female": { "60-64": 8, "65-69": 11, "70-74": 15, "75-79": 21, "80-84": 28 },
        "Male":   { "60-64": 10, "65-69": 14, "70-74": 19, "75-79": 26, "80-84": 34 }
      },
      "Brazil": {
        "Female": { "60-64": 7, "65-69": 10, "70-74": 14, "75-79": 19, "80-84": 25 },
        "Male":   { "60-64": 9, "65-69": 12, "70-74": 17, "75-79": 23, "80-84": 30 }
      },
      "China": {
        "Female": { "60-64": 6, "65-69": 9, "70-74": 12, "75-79": 17, "80-84": 23 },
        "Male":   { "60-64": 8, "65-69": 11, "70-74": 15, "75-79": 21, "80-84": 28 }
      }
    };

    // Map location to SVG element ID
    const LOCATION_MAP_IDS = {
      "United States": "mapUS",
      "Brazil": "mapBrazil",
      "China": "mapChina"
    };

    // =========================================================================
    // STATE
    // =========================================================================

    let currentSex = "Female";
    let selectedLocation = null;
    let selectedAge = null;

    // =========================================================================
    // DOM ELEMENTS
    // =========================================================================

    const sensitivitySlider = document.getElementById('sensitivitySlider');
    const sensitivityNum = document.getElementById('sensitivityNum');
    const specificitySlider = document.getElementById('specificitySlider');
    const specificityNum = document.getElementById('specificityNum');
    const prevalenceSlider = document.getElementById('prevalenceSlider');
    const prevalenceNum = document.getElementById('prevalenceNum');

    const seSliderVal = document.getElementById('seSliderVal');
    const spSliderVal = document.getElementById('spSliderVal');
    const prevSliderVal = document.getElementById('prevSliderVal');

    const btnFemale = document.getElementById('btnFemale');
    const btnMale = document.getElementById('btnMale');
    const prevalenceTableBody = document.getElementById('prevalenceTableBody');

    const ppvValue = document.getElementById('ppvValue');
    const ppvWarning = document.getElementById('ppvWarning');
    const formulaDetails = document.getElementById('formulaDetails');
    const mapLabel = document.getElementById('mapLabel');

    // =========================================================================
    // UTILITY
    // =========================================================================

    function clampAndRound(val) {
      const num = parseFloat(val);
      if (isNaN(num)) return 0;
      return Math.max(0, Math.min(100, Math.round(num)));
    }

    // =========================================================================
    // PPV CALCULATION
    // =========================================================================

    function calculatePPV(sensitivityPct, specificityPct, prevalencePct) {
      const se = sensitivityPct / 100;
      const sp = specificityPct / 100;
      const prev = prevalencePct / 100;

      const truePos = se * prev;
      const falsePos = (1 - sp) * (1 - prev);
      const denom = truePos + falsePos;

      if (denom === 0) {
        return { ppv: null, numerator: truePos, denominator: denom, se, sp, prev };
      }

      return { ppv: truePos / denom, numerator: truePos, denominator: denom, se, sp, prev };
    }

    // =========================================================================
    // UI UPDATE
    // =========================================================================

    function syncFromSlider(slider, numInput, valDisplay) {
      numInput.value = slider.value;
      valDisplay.textContent = slider.value;
      updateCalculation();
    }

    function syncFromInput(slider, numInput, valDisplay) {
      const val = clampAndRound(numInput.value);
      numInput.value = val;
      slider.value = val;
      valDisplay.textContent = val;
      updateCalculation();
    }

    function updateCalculation() {
      const se = parseInt(sensitivityNum.value, 10);
      const sp = parseInt(specificityNum.value, 10);
      const prev = parseInt(prevalenceNum.value, 10);

      const result = calculatePPV(se, sp, prev);

      if (result.ppv === null) {
        ppvValue.textContent = '—';
        ppvWarning.textContent = 'Undefined: no positive tests occur';
      } else {
        ppvValue.textContent = (result.ppv * 100).toFixed(1) + '%';
        ppvWarning.textContent = '';
      }

      formulaDetails.innerHTML = `
        <div class="formula-line intermediate">Se = ${result.se.toFixed(4)}, Sp = ${result.sp.toFixed(4)}, Prev = ${result.prev.toFixed(4)}</div>
        <div class="formula-line">PPV = (Se × Prev) / (Se × Prev + (1 − Sp) × (1 − Prev))</div>
        <div class="formula-line">PPV = ${result.numerator.toFixed(6)} / ${result.denominator.toFixed(6)}</div>
        <div class="formula-line">PPV = ${result.ppv !== null ? result.ppv.toFixed(4) : 'undefined'}</div>
      `;
    }

    // =========================================================================
    // PREVALENCE TABLE
    // =========================================================================

    function buildPrevalenceTable() {
      prevalenceTableBody.innerHTML = '';

      AGE_GROUPS.forEach(age => {
        const tr = document.createElement('tr');
        tr.dataset.age = age;

        // Age cell
        const tdAge = document.createElement('td');
        tdAge.textContent = age.replace('-', '–');
        tr.appendChild(tdAge);

        // Location cells
        LOCATIONS.forEach(loc => {
          const td = document.createElement('td');
          const val = PREVALENCE_DATA[loc]?.[currentSex]?.[age];
          if (val !== undefined) {
            td.innerHTML = `<span class="prev-value">${val}%</span>`;
            td.dataset.location = loc;
            td.dataset.prevalence = val;
          } else {
            td.textContent = '—';
          }
          tr.appendChild(td);
        });

        // Click handler for entire row
        tr.addEventListener('click', (e) => {
          const cell = e.target.closest('td[data-location]');
          if (cell) {
            selectPrevalence(age, cell.dataset.location, parseInt(cell.dataset.prevalence, 10));
          }
        });

        prevalenceTableBody.appendChild(tr);
      });

      updateTableSelection();
    }

    function selectPrevalence(age, location, value) {
      selectedAge = age;
      selectedLocation = location;

      prevalenceNum.value = value;
      prevalenceSlider.value = value;
      prevSliderVal.textContent = value;

      updateTableSelection();
      updateMapSelection();
      updateCalculation();
    }

    function updateTableSelection() {
      // Clear all selections
      prevalenceTableBody.querySelectorAll('tr').forEach(tr => {
        tr.classList.remove('selected');
      });

      // Apply selection if we have one
      if (selectedAge && selectedLocation) {
        const tr = prevalenceTableBody.querySelector(`tr[data-age="${selectedAge}"]`);
        if (tr) {
          tr.classList.add('selected');
        }
      }
    }

    // =========================================================================
    // MAP
    // =========================================================================

    function updateMapSelection() {
      // Clear all
      document.querySelectorAll('.map-svg .country').forEach(el => {
        el.classList.remove('active');
      });

      // Highlight selected
      if (selectedLocation && LOCATION_MAP_IDS[selectedLocation]) {
        const el = document.getElementById(LOCATION_MAP_IDS[selectedLocation]);
        if (el) el.classList.add('active');
        mapLabel.textContent = selectedLocation;
      } else {
        mapLabel.textContent = 'Click to select';
      }
    }

    function initMap() {
      document.querySelectorAll('.map-svg .country').forEach(el => {
        el.addEventListener('click', () => {
          const loc = el.dataset.location;
          if (loc && selectedAge) {
            // Use current age selection with new location
            const val = PREVALENCE_DATA[loc]?.[currentSex]?.[selectedAge];
            if (val !== undefined) {
              selectPrevalence(selectedAge, loc, val);
            }
          } else if (loc) {
            // No age selected, just highlight and use first age group
            const val = PREVALENCE_DATA[loc]?.[currentSex]?.[AGE_GROUPS[0]];
            if (val !== undefined) {
              selectPrevalence(AGE_GROUPS[0], loc, val);
            }
          }
        });
      });
    }

    // =========================================================================
    // SEX TOGGLE
    // =========================================================================

    function setSex(sex) {
      currentSex = sex;
      btnFemale.classList.toggle('active', sex === 'Female');
      btnMale.classList.toggle('active', sex === 'Male');
      buildPrevalenceTable();

      // Update prevalence if we have a selection
      if (selectedAge && selectedLocation) {
        const val = PREVALENCE_DATA[selectedLocation]?.[currentSex]?.[selectedAge];
        if (val !== undefined) {
          prevalenceNum.value = val;
          prevalenceSlider.value = val;
          prevSliderVal.textContent = val;
          updateCalculation();
        }
      }
    }

    // =========================================================================
    // EVENT LISTENERS
    // =========================================================================

    // Sliders
    sensitivitySlider.addEventListener('input', () => syncFromSlider(sensitivitySlider, sensitivityNum, seSliderVal));
    specificitySlider.addEventListener('input', () => syncFromSlider(specificitySlider, specificityNum, spSliderVal));
    prevalenceSlider.addEventListener('input', () => {
      syncFromSlider(prevalenceSlider, prevalenceNum, prevSliderVal);
      selectedAge = null;
      selectedLocation = null;
      updateTableSelection();
      updateMapSelection();
    });

    // Number inputs
    sensitivityNum.addEventListener('input', () => syncFromInput(sensitivitySlider, sensitivityNum, seSliderVal));
    sensitivityNum.addEventListener('blur', () => syncFromInput(sensitivitySlider, sensitivityNum, seSliderVal));
    specificityNum.addEventListener('input', () => syncFromInput(specificitySlider, specificityNum, spSliderVal));
    specificityNum.addEventListener('blur', () => syncFromInput(specificitySlider, specificityNum, spSliderVal));
    prevalenceNum.addEventListener('input', () => {
      syncFromInput(prevalenceSlider, prevalenceNum, prevSliderVal);
      selectedAge = null;
      selectedLocation = null;
      updateTableSelection();
      updateMapSelection();
    });
    prevalenceNum.addEventListener('blur', () => syncFromInput(prevalenceSlider, prevalenceNum, prevSliderVal));

    // Sex toggle
    btnFemale.addEventListener('click', () => setSex('Female'));
    btnMale.addEventListener('click', () => setSex('Male'));

    // =========================================================================
    // INIT
    // =========================================================================

    buildPrevalenceTable();
    initMap();
    updateCalculation();

    // =========================================================================
    // TEST CASES
    // =========================================================================
    /*
    Test 1: Se=50%, Sp=90%, Prev=10%
      PPV = 0.05 / 0.14 = 0.3571 → 35.7% ✓

    Test 2: Se=90%, Sp=99%, Prev=1%
      PPV = 0.009 / 0.0189 = 0.4762 → 47.6%

    Test 3: Se=80%, Sp=100%, Prev=5%
      PPV = 0.04 / 0.04 = 1.0 → 100%

    Test 4: Se=0%, Sp=100% → denominator=0 → "—"
    */
  </script>
</body>
</html>
