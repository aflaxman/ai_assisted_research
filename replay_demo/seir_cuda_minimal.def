Bootstrap: docker
From: ubuntu:22.04

%labels
    Author IHME
    Version 2.0
    Description SEIR disease simulation - minimal image for --nv binding

%help
    Minimal SEIR CUDA container designed to work with Singularity --nv.

    This container does NOT include CUDA libraries - they are provided
    by the host system via --nv flag, avoiding overlay conflicts.

    Usage:
        # MUST use --nv flag to bind host NVIDIA libraries
        singularity exec --nv seir_cuda_minimal.sif python3 /app/seir_cuda_simulation.py --n-sims 1000

%post
    # Update system and install dependencies
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        && rm -rf /var/lib/apt/lists/*

    # Install Python packages
    # NOTE: numba will use CUDA libraries from host via --nv
    pip3 install --no-cache-dir \
        numpy>=1.24.0 \
        numba>=0.58.0 \
        matplotlib>=3.7.0 \
        pytest>=7.0.0

    # Create app directory
    mkdir -p /app

    # Create placeholder CUDA directory (host libraries will be bound here)
    mkdir -p /usr/local/cuda/lib64

%files
    seir_cuda_simulation.py /app/seir_cuda_simulation.py
    seir_contact_simulation.py /app/seir_contact_simulation.py
    visualize_results.py /app/visualize_results.py
    test_seir_cuda.py /app/test_seir_cuda.py

%environment
    export LC_ALL=C
    # Host CUDA binaries and libraries are provided via --nv
    export PATH=/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

%runscript
    echo "SEIR CUDA Simulation Container (Minimal)"
    echo "========================================="
    echo ""
    echo "IMPORTANT: Must use --nv flag for GPU access!"
    echo ""
    echo "Available commands:"
    echo "  python3 /app/seir_cuda_simulation.py --help"
    echo "  python3 /app/test_seir_cuda.py"
    echo ""
    echo "Running default benchmark..."
    exec python3 /app/seir_cuda_simulation.py "$@"

%test
    echo "Testing Python dependencies..."
    python3 -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
    python3 -c "import numba; print(f'Numba version: {numba.__version__}')"
    echo "Note: CUDA libraries must be provided at runtime via --nv flag"
    echo "Build-time tests complete!"
